Coherent Probabilistic Forecasts for Hierarchical Time Series

Souhaib Ben Taieb   James    Taylor   Rob    Hyndman  

Abstract

Many applications require forecasts for   hierarchy comprising   set of time series along with
aggregates of subsets of these series  Hierarchical forecasting require not only good prediction accuracy at each level of the hierarchy  but
also the coherency between different levels  
the property that forecasts add up appropriately
across the hierarchy    fundamental limitation
of prior research is the focus on forecasting the
mean of each time series  We consider the situation where probabilistic forecasts are needed for
each series in the hierarchy  and propose an algorithm to compute predictive distributions rather
than mean forecasts only  Our algorithm has the
advantage of synthesizing information from different levels in the hierarchy through   sparse
forecast combination and   probabilistic hierarchical aggregation  We evaluate the accuracy of
our forecasting algorithm on both simulated data
and largescale electricity smart meter data  The
results show consistent performance gains compared to stateof the art methods 

  Introduction
Producing forecasts that support decisionmaking in   hierarchical structure is   central problem for many organizations  For example  retail sales forecasts typically form
  hierarchy  with the inventory control system of   retail
outlet relying on forecasts for storelevel demand  while
forecasts of regionally aggregated demand are needed for
managing inventory at   distribution centre  Kremer et al 
  Another context where   hierarchy naturally arises
is electricity demand  where the bottom level might consist
of time series of the electricity consumption of individual
customers  while the top level could be the total load on
the grid  Forecasts of electricity consumption are needed at

 Monash University  Melbourne  Australia  University of
Oxford  Oxford  UK  Correspondence to  Souhaib Ben Taieb
 souhaib bentaieb monash edu 

Proceedings of the   th International Conference on Machine
Learning  Sydney  Australia  PMLR     Copyright  
by the author   

various levels of aggregation in order to operate the power
grid ef ciently and securely  van Erven   Cugliari   
Producing accurate forecasts for these hierarchical structures is particularly challenging  First  the many time series
involved can interact in varying and complex ways  In particular  time series at different levels of the hierarchy can
contain very different patterns  see  for example  Figure
  time series at the bottom level are typically very noisy
sometimes exhibiting intermittency  while aggregated series at higher levels are much smoother  As   result    naive
bottomup approach whereby forecasts of aggregates are
generated by summing the forecasts of the corresponding
series in the lower levels is unlikely to deliver accurate results when the aggregation involves   large number of series  Hyndman et al    Second  in order to ensure
coherent decisionmaking at the different levels of   hierarchy  it is essential that the forecast of each aggregated series
should equal the sum of the forecasts of the corresponding
disaggregated series  Unfortunately  independently forecasting each time series within each level is very unlikely
to deliver coherent forecasts  Finally  the bottom level can
consist of several thousand or even millions of time series 
which can induce   massive computational load 
Recent work in this area  Wickramasuriya et al    van
Erven   Cugliari    has focused on   twostage approach in which base forecasts are  rst produced independently for each series in the hierarchy  these are then combined to generate coherent revised forecasts  see Section  
The rationale behind this approach is both to improve forecast accuracy due to the synthesis of information from different forecasts  as well as to produce coherent forecasts 
  fundamental limitation of actual research is that it has
looked only at the problem of forecasting the mean of each
time series  This contrasts with the shift in the forecasting
literature over the past two decades towards probabilistic
forecasting  Gneiting   Katzfuss    This form of prediction quanti es the uncertainty  which enables improved
decision making and risk management  see  for example 
Berrocal et al   
We address the key problem of generating probabilistic
forecasts for largescale hierarchical time series  This is
particularly challenging since it is requires the estimation
of the entire distribution of future observations  not only
the mean  Kneib    Hothorn et al    Furthermore 

Coherent Probabilistic Forecasts for Hierarchical Time Series

because of the hierarchical structure  this problem also involves computing the distribution of hierarchical sums of
random variables in high dimensions  Finally  another challenge is the possible variety of distributions in the hierarchy  In fact  although the distributions become more normally distributed with the aggregation level as   consequence of the central limit theorem  the series at lower levels often exhibit nonnormality including multimodality
and high levels of skewness 
We propose an algorithm that computes predictive distributions under the form of random samples for each series
in the hierarchy  First  probabilistic forecasts are independently computed for all series in the hierarchy  and samples are computed from the associated predictive distributions  Then    sequence of permutations extracted from
estimated copulas are applied to the multivariate samples
in   hierarchical manner to restore the dependencies between the variables before computing the sums  see Section   Finally  the algorithm computes sparse forecast
combinations for all series in the hierarchy  where the combination weights are estimated by solving   possibly highdimensional LASSO problem  see Section   The result
is   set of coherent probabilistic forecasts for each series in
the hierarchy 
Our algorithm has multiple advantages compared to the
stateof the art hierarchical forecasting methods 
  it
quanti es the uncertainty in the predictions for the entire
hierarchy while satisfying the aggregation constraints    it
is scalable to highdimensional hierarchies since the problem is decomposed into multiple lowerdimensional subproblems  and   it synthesizes information from different
levels in the hierarchy to estimate the marginal distributions
and the dependence structures through the mean forecast
combination and the hierarchical aggregation  respectively 
We evaluate our algorithm using both simulated data sets
 see Section   and   large scale electricity smart meter
data set  see Section  

  Mean Hierarchical Forecasting
  hierarchical time series is   multivariate time series with
  hierarchical structure  Figure   gives an example with
 ve bottom series and three aggregate series  The different observations in the hierarchy satisfy the following aggregation constraints  yt   yA     yB    yA     yAA    
yAB   yAC   and yB     yBA   yBB   for all time periods
                 
Let at be an rvector containing the observations at the
different levels of aggregation at time    bt be an mvector
with the observations at the bottom level only  and yt  
 at bt cid  be an nvector that contains the observations of
all series in the hierarchy with            For the ex 

yt

yA  

yB  

yAA  

yAB  

yAC  

yBA  

yBB  

Figure   Example of   hierarchical time series  

 cid cid          

  Im

then write yt   Sbt  where    cid   cid 

ample in Figure   we have at    yt  yA    yB   cid  bt  
 yAA    yAB            yBB   cid        and       We can
is the summing matrix  Sa          and Im is an identity matrix of order   
Suppose we have access to   historical observations 
           yT   of   hierarchical time series  Under mean
squared error  MSE  loss  the optimal hperiod ahead forecasts are given by the conditional mean  Gneiting   
    

  yT               yT         bT               yT  

 

where                   
It is possible to compute forecasts for all series at all levels
independently  which we call base forecasts  For example 
we can estimate   yi      yi          yi     for                 
     for all series in the hierarchy  This approach is very
 exible since we can use different forecasting methods for
each series and aggregation level  However  the aggregation constraints will not necessarily be satis ed 
De nition   The coherency errors of the hperiod ahead
 bT    cid  are given by
base forecasts  yT       aT   
 rT       aT      Sa
In other words   rT    is   vector containing the magnitude
of constraint violations for each aggregate series 
De nition   The hperiod ahead base forecasts  yT     
 bT    cid  are  mean  coherent if  rT             if
 aT   
there are no coherency errors 

 bT    

Since the optimal mean forecasts in   are coherent by
de nition 
it seems sensible to impose the aggregation
constraints when generating hierarchical mean forecasts 
Also  from   decisionmaking perspective  coherent forecasts will guarantee coherent decisions over the entire hierarchy 

  Best Linear Unbiased Mean Revised Forecasts

Hyndman et al    proposed coherent hierarchical
mean forecasts of the following form 

 yT      SP  yT    

 

Coherent Probabilistic Forecasts for Hierarchical Time Series

for some appropriately chosen matrix     Rm    and
where  yT    are some base forecasts 
This approach has multiple advantages    the forecasts
are coherent by construction    the forecasts are generated by combining forecasts from all levels  and   multiple hierarchical forecasting methods can be represented
as particular cases 
including bottomup forecasts with

 cid  and topdown forecasts with    
 cid  where   is   vector of proportions that

     cid        
 cid pm     

     

sum to one 
Theorem    Adapted from Wickramasuriya et al   
Let Wh be the positive de nite covariance matrix of the hperiod ahead base forecast errors   eT      yT      yT    
     Wh     eT       cid 
Then  assuming unbiased base forecasts 
the best
      having minimum sum of variances  linear unbiased revised forecasts are given by   with    
   cid    
    We will denote this method MinT 
In practice  the error covariance matrix Wh needs to be estimated using historical observations of the base forecast
errors  Wickramasuriya et al    estimated    and
assumed that Wh      since the estimation of Wh is
challenging for       To trade off bias and estimation
variance  structural assumptions on the entries of the sample covariance matrix have also been considered in Hyndman et al   

      cid    

  Optimal Mean Combination and Reconciliation

The approach presented in the previous section applies both
combination and reconciliation of the forecasts at the same
time  van Erven   Cugliari   proposed splitting the
problem into two independent steps   rst one comes up
with the best possible forecasts for the time series without
worrying about aggregate consistency  and then   reconciliation procedure is used to make the forecasts aggregate
consistent 
Given some possibly incoherent base forecasts  yT     and
  weight matrix     Rn    they proposed   method called
GTOP  which solves the following quadratic optimization
problem 

 cid cid cid cid    yT       

 cid xa

 cid cid cid cid cid 

minimize
xa Rr xb Rm
xb
subject to  xa xb cid          

 

reconciled and the base forecasts  When       and      
the problem reduces to  nding the closest reconciled forecasts to the base forecasts in terms of sum of squared errors
 SSE 
  distinctive advantage of the GTOP approach compared
to MinT is the guarantee of producing revised forecasts
 yT         
   cid  with the same or smaller SSE than
the base forecasts  yT     Furthermore  compared to MinT 
the base forecasts are not required to be unbiased  Also 
by separating forecast combination and reconciliation  the
GTOP approach allows the inclusion of regularization in
the forecast combination step  One comparative weakness
of GTOP is that it does not have   closedform solution in
the general case 

    

  Probabilistic Hierarchical Forecasting
There has been   shift in the forecasting literature  over the
past two decades  towards probabilistic forecasting  Gneiting   Katzfuss    This form of prediction quanti es
the uncertainty  which enables improved decision making
and risk management  GTOP does not provide any quanti 
cation of the uncertainty in the predictions  and  although
MinT allows the calculation of the forecast variances  this
might not be enough to fully describe the uncertainty in the
predictions 
We propose an algorithm to compute  for all series in the hierarchy  the conditional predictive cumulative distribution
function 

Fi                   yT       yi                     yT  

rather than just the conditional mean   yi                 yT  
and conditional variance   yi                 yT   with    
            
As with mean forecasts  it is possible to independently
compute probabilistic forecasts for each series in the hierarchy  but  again  these forecasts will not necessarily be
coherent  In fact  hierarchical probabilistic forecasts are coherent if the predictive distribution of each aggregate series
is equal to the distribution of the sum of the children series 
Naturally  probabilistic coherency implies mean coherency
as given in De nition  

  BottomUp Probabilistic Forecasting

where      xa xb cid    xa   Saxb  is the set of coherent
vectors  and   is an additional set that allows the speci cation of additional constraints 
The solution of the previous problem is also equivalent to
an optimal strategy in   minimax problem where the goal
is to minimize the maximum error between the loss of the

With mean forecasts  it was possible to compute coherent
bottomup forecasts for the ith aggregated series by simply
summing the associated lowest level mean forecasts      
 bt where si is the ith row of the   matrix  and
 yit   si
                 Now  given some base probabilistic forecasts
for all the bottom series  how do we compute the bottomup
coherent probabilistic forecasts for all aggregated series 

Coherent Probabilistic Forecasts for Hierarchical Time Series

Since each aggregate series is the sum of   subset of bottom series  bottomup probabilistic forecasting is harder to
compute than mean forecasting because we need to compute the joint distribution of the component random variables  The marginal predictive distributions are not enough 
De nition   Let            Xd be   set of continuous random variables with joint distribution function     Then  the

distribution of    cid  
 cid 

FX Xd      

Rd

   Xi is given by
   xd      dF             xd 
 

the joint distribution  we can use the copTo model
ula framework  Nelsen    Copulas originate from
Sklar   theorem  Sklar    which states that
for
any continuous distribution function   with marginals
           Fd  there exists   unique function           
    such that   can be written as               xn   
               Fd xd 
In other words  starting from
marginal predictive distributions for each series  and using
  copula for the dependence structure  we can  rst compute
the joint distribution  and then compute the distribution of
the sum using  
Although it is convenient to decompose the estimation
of the joint distribution into the estimation of multiple
marginal predictive distributions and one copula  the number of bottom series can be large in practice  which implies   highdimensional copula  Furthermore  in highly
disaggregated time series data  the bottom series are often
very noisy  and as   result  the estimation of the dependence
structure between all bottom series will be very challenging 
Since we are only interested in speci   aggregations  we
can avoid explicitly modelling the  often  highdimensional
copula that describes the dependence between all bottom
series  Building on the approach proposed by Arbenz
et al    we propose to decompose the possibly highdimensional copula into multiple lowerdimensional copulas for all child series of each aggregate series 
Example   Let us consider the hierarchy given
in Figure  
  classical bottomup approach
joint distribution of
would require modelling the
 yAA    yAB    yAC    yBA    yBB   
the distribution of all aggregate series yA    yB   and yt can be
computed using  
However  since the marginals and the copula completely
specify the joint distribution  the following procedure allows us to compute the marginal predictive distributions of
all aggregates using three lowerdimensional copulas in  
hierarchal manner 

Then 

  Compute FAA    FAB    FAC    FBA    and FBB   

  Compute FA   using   FAA    FAB    FAC   
  Compute FB   using   FBA    FBB   
  Compute Ft using   FA    FB   

Except in some special cases where the distribution of the
sum can be computed analytically  we would typically resort to Monte Carlo simulations 
By Sklar   theorem  we can write               xd   
                  Xd   xd                   Fd xd 
    Fi  and uk  
Suppose we have samples xi
   

                         then we can compute

           ud

               xd                       Fd xd 

where  Fi are the empirical margins and    is the empirical
copula  see   uschendorf    and the references therein 
given respectively by

 xi

             

 cid 

 
 

  cid 
 cid rk   

  

 Fi     

  cid 

  

 

 
 

and

  

  

 

       

  ud

 

          ui

            

   is the rank of

rk ud
  
 
for                 ud          where rk ui
  within the set  ui
ui
The procedure of applying empirical copulas to empirical
margins can be ef ciently represented in terms of sample
reordering  In fact  the order statistics ui
    of the
samples ui
  induce   permutation pi of the integers
             de ned by pi      rk ui
   for                 
If we then apply the permutations to each independent
   the reordered samples inmarginal sample  xi
herit the multivariate rank dependence structure from the
copula     We can then compute the samples for the sum

            xK  where xk  cid  

          ui

          ui

          xi

  
   xi

Introducing   dependence structure into originally independent marginal samples goes back to Iman   Conover
  who considered the special case of normal copulas    similar idea has been considered more recently in
Schefzik et al    to specify multivariate dependence
structure with applications to weather forecasting 
Since we are interested in multivariate forecasting  we will
need another version of Sklar   theorem for conditional
joint distributions proposed by Patton  

If yt Ft       Ft 
with yit Ft    Fi Ft 
then

                

     Ft          Ft          Fn yn Ft Ft 

Coherent Probabilistic Forecasts for Hierarchical Time Series

As in Patton   we will assume the following structure
for our series 

 
yit      yt  yt               yt  yt         it 
where  it yt  yt    Fi    In other words  each
series can have   potentially timevarying conditional mean
and variance  but the standardized residual   it  has   constant conditional distribution for simplicity  See Fan   Patton   for   review on copulas in econometrics 
The following algorithm describes how to compute the
bottomup samples using the reordering procedure for  
complete hierarchy 
Algorithm    Bottomup Probabilistic Forecasting 

  For all series in the hierarchy  as de ned in   model
the conditional marginal distributions       compute   
and    for                 
  Then  compute the standardized residuals  it  
 yi               and de ne the permutations pi     
rk it  where                 and                  

  For all bottom series                     

    Compute hperiod ahead conditional marginal

predictive distributions  Fi      
        

    Extract   discrete sample of size         say
               and

   where xi

xi
          xi
                

  For all aggregate series                 

    Let              nc  be the nc children series of

the aggregate series   
    Recursively compute

 pi          xi nc 

    xi 
xi
    denotes the kth order statistics of
        xi

        xi

 pi nc    

    xi

   

where xi
 xi

          xi

Similarly to the classical bottomup algorithm  Algorithm  
produces coherent samples by construction  Furthermore 
the samples of each aggregate are computed using only the
predictive distributions of the bottom series  However  Algorithm   has two main advantages compared to   classical bottomup algorithm    instead of estimating   highdimensional copula for the dependence between all the bottom series  we only need to specify the joint dependence
between the child series of each aggregate series  and  
since each copula is estimated at different aggregate levels 
we can bene   from better estimation since the series are
smoother  and easier to model and forecast 

  Mean Forecast Combination and Reconciliation

Algorithm   computes bottomup probabilistic forecasts
by estimating the copula dependence functions using data
from different levels of the hierarchy  However  the resulting mean forecasts are equal to classical bottomup forecasts       no data from other levels is used  In order to

further improve the accuracy of our probabilistic forecasts 
we add   mean forecast combination step  which allows
to exploit possibly better mean forecasts from higher levels  Forecast combination is known to improve forecasts
in many cases  Timmermann    Genre et al   
We could adjust the means of our predictive distributions
using the MinT revised forecasts  However  as van Erven
  Cugliari   we propose to  rst combine the mean
forecasts  and then apply   reconciliation step 
Let  yT    be the means of our predictive distributions  We
compute the following forecast combination 

where    cid            qn

 yt      yt 

 cid cid    Rn   is   weight matrix 

 

Since the combined mean forecasts  yt are not necessarily coherent  we also apply   reconciliation step using the
GTOP approach described in Section   More precisely 
we solve the quadratic optimization problem in   and obtain reconciled forecasts  yt 
Since the total number of series in the hierarchy     can
be very large compared to the number of observations    
it is necessary to use some regularization for the weights 
Therefore  we will estimate the weights by solving the following    optimization problem 

minimize

 

 
 

 cid yt      yt cid   

    cid qi cid   

  

  

where        is   regularization parameter for the ith
weight vector qi  The previous problem can be rewritten
as

  cid 

  cid 

  cid 

  cid 

  cid 

 
 

minimize

  qn

 yit      cid 

tqi   

    cid qi cid   

  

  

  

which is decomposable in the vectors qi  As   result  we
can solve the   problems independently  Our implementation of the LASSO is based on   cyclical coordinate descent algorithm  Friedman et al    and the regularization parameters are selected by minimizing time series
crossvalidated errors  Hyndman   Athanasopoulos   
Section  
The forecast combination that we are considering in   has
multiple advantages compared to the MinT forecast combination in   First  since     Rn    all series in the hierarchy can bene   directly from the forecast combination 
not only the bottom series as in MinT with     Rm   
Second  we do not assume the base forecast are unbiased 
and we do not seek to compute unbiased revised forecasts
as in MinT  We rather seek to optimize the weights in order
to obtain combined forecasts with low forecast errors      

Coherent Probabilistic Forecasts for Hierarchical Time Series

with the right tradeoff between bias and estimation variance  Finally  even if we start with coherent base forecasts  we can still apply   forecast combination  and eventually reconcile them later  In contrast with MinT  no forecast combination will be applied in that case  Of course 
MinT has the advantage of having   closedform solution 
which does not require the solution of   possibly highdimensional regression problems  Finally  our reconciled
forecasts are guaranteed to have smaller or equal SSE than
the combined forecasts  which is guaranteed by the GTOP
method as discussed in Section   Our  nal algorithm can
be summarized as follows 
Algorithm    Mean Combined and Reconciled Probabilistic Forecasting 

  Run Algorithm   to obtain bottomup samples for
  with    

all series in the hierarchy  say xi
            

          xi

  Extract mean forecasts  yT    from all base predictive
distributions  Fi       and compute combined forecasts
 yT    given in  

  Given   weight matrix    and using the combined
forecasts  yT    as base forecasts  solve the optimization problem in   to obtain reconciled forecasts
 yT    
   
     and       yi     yi   yi     yi       yi     yi  
xi
is an adjustment term  with                 

  Compute revised samples  xi

  where  xi

           xi

Algorithm   computes coherent forecasts since both the
bottomup samples  computed using Algorithm   and the
reconciled means are coherent 

  NAIVEBU 

  Experiments
We compare the following forecasting methods    BASE 
the base predictive distributions 
the
naive bottomup forecasts computed by summing independent samples from the bottom predictive distributions  without forecast combination    PERMBU  the
bottomup forecasts computed using Algorithm    withforecast combination 
out
  PERMBUMINT  simto PERMBU with mean forecasts computed usilar
ing MinT 
the forecasts are
computed using Algorithm   with       
and
similar to PERMBUGTOP  but
  PERMBUGTOP 
       bottomup instead
with     diag           
             

  PERMBUGTOP 

 cid   cid cid   cid 

 

 cid   cid cid   cid 

 

of reconciled combined mean forecasts 

  Probabilistic Forecast Evaluation

We evaluate our predictive distributions using the continuous ranked probability score  CRPS  which is   proper
scoring rule       the score is maximized when the true dis 

tribution is reported  Gneiting   Raftery    Given an
hperiod ahead cumulative predictive distribution function
 Ft   and an observation yt    the CRPS can be de ned as
 Gneiting   Ranjan   

CRPS   Ft    yt     

QS 

       yt  

  

 cid   

 

 cid      

 cid 

where QS  is the quantile score  de ned as

 cid      
 cid 

QS 

   

       yt  
 yt         

 cid 
          

 cid cid      

         yt  

 cid 

 

which is also known as the pinball or check loss  Koenker
  Bassett   
In order to quantify the gain loss of the different methods
with respect to the base forecasts  we compute the Skill
Score de ned as  SCOREBASE   SCORE SCOREBASE
where SCORE is the considered evaluation score  Low values of the score are desirable  and so high positive values
are preferable for the skill score  In the following experiments  SCORE will be computed by averaging the CRPS
or QS over all observations in the test set  Finally  as proposed by Laio   Tamea   we will plot the QS   skill
score  versus   as   diagnostic tool in the comparison of
the different methods 

  Simulated Data

We begin with simulated time series  implemented using
the same processes as Wickramasuriya et al    to evaluate different hierarchical forecasting methods  However 
we focus on distributional forecasts rather than mean forecasts  We used   hierarchy with four bottom series  where
the two pairs of bottom series are aggregated in two aggregate series  which are then aggregated in   top series 
Hence  the hierarchy is composed of       series       
bottom series and       aggregate series 
Each series in the bottom level
is generated from an
ARIMA          process  with   and   taking values of  
  and   with equal probability and   taking values of   and
  with equal probability  The parameters are chosen randomly from   uniform distribution from   speci   parameter space for each each component of the ARIMA process  see Table   in Wickramasuriya et al    The
error terms of the bottomlevel ARIMA processes have  
multivariate Gaussian distribution with   covariance structure that allows   strongly positive correlation among series
with the same parents  but   moderately positive correlation
among series with different parents 
For each series  we generate         or   observations  with an additional       observations as   test set 

Coherent Probabilistic Forecasts for Hierarchical Time Series

We    an ARIMA model by minimizing the AIC  and compute  period ahead Gaussian predictive distributions as
base forecasts  The whole process is repeated     times 
Figure   shows the results for       The  rst panel
gives the CRPS skill score for each horizon  the second and
third panels show the QS skill score averaged over horizons
      and       respectively  the last panel gives
the CRPS skill score for the bottom level 
In the  rst panel  we can see that PERMBU has   better
skill score than NAIVEBU until horizon   and vice versa
for the subsequent horizons  The second panel shows that
PERMBU outperforms NAIVEBU especially in the lower
and upper tails  In other word  the independence assumption of NAIVEBU is not valid  and modelling the dependence structure between the children series of each aggregated series provides better tail forecasts for the aggregate
series  The third panel shows that NAIVEBU has consistently better QS skill score compared to PERMBU for horizons   This suggests that using oneperiod ahead dependence structure for   to  period ahead forecasts      
using   misspeci ed dependence structure  is worse than
assuming independence 
The  rst panel also shows that the methods using forecast
combinations have signi cantly increased the CRPS skill
score compared to PERMBU  This suggests that the mean
forecast combination step is particularly useful in further
improving the distributional forecasts  Furthermore  we
can see that PERMBUGTOP  has better skill score than
PERMBUMINT until horizon   This shows the bene  
of our forecast combination  which learns the best combination weights  without making an unbiasedness assumption  The better skill score of PERMBUGTOP  compared
to PERMBUGTOP  suggests an advantage in splitting the
forecast combination and reconciliation steps  The same
observations can be made in the last panel for the bottom
level 
Finally  with   larger training set size        and
      the forecast combination methods have similar
skill scores  as can be seen in Figures    and    in the appendix  With more observations  the  tted ARIMA model
becomes more accurate  and therefore  forecast combination is less likely to improve the base forecasts  However 
even with   large training set  modeling the dependence
structure is still important  as shown by the better skill score
of PERMBU compared to NAIVEBU 

  Electricity Smart Meter Data

We used smart meter electricity consumption data collected
by four energy supply companies in Great Britain  AECOM    Consumption was recorded at halfhourly
intervals for more than   households  along with ge 

Figure   Skill CRPS and skill QS for aggregate and bottom levels for         positive negative skill gives the percentage
of increase decrease in forecast accuracy with respect to the base
forecasts 

ographic and demographic information  In our study  we
were interested only in relatively long time series without
missing values  and this led us to use data recorded at  
meters for the period   April   to   July   inclusive  Each series  therefore  consisted of         halfhourly observations  We constructed   hierarchy based on
geographical information comprising four levels of aggregation with         series in the bottom level of the
hierarchy  and       aggregated series in the other three
levels of the hierarchy   Figure   presents observations for
  oneweek period for just one series taken from each of
the four levels of the hierarchy  The values shown on the
right hand side of the  gure correspond to the number of
bottom level series that have been summed to give each of
the aggregated series in the  gure 
We considered the problem of oneday ahead       the next
      halfhours  probabilistic demand forecasting  with
  forecast origin at   for each day  We split each
time series into training  validation and test sets  the  rst  
months for training  the next month for validation and the
remaining  approximately  three months for testing  Each
model is reestimated before forecasting each day in the test
set using   rolling window of the historical observations 
We used different forecasting methods for the aggregate
and bottom series  For the aggregate series  we capture the
yearly cycle  the withinday and withinweek seasonalities
using seasonal Fourier terms with coef cients estimated by

 Aggregate levelsHorizonSkill CRPS Aggregate levels        Probability levelSkill Quantile ScoreBASEPERMBU GTOP NAIVEBUPERMBUPERMBU MINTPERMBU GTOP Aggregate levels        Probability levelSkill Quantile Score Bottom levelHorizonSkill CRPSCoherent Probabilistic Forecasts for Hierarchical Time Series

the other methods  which are penalized by the QS 
Overall  the  rst panel shows that the mean forecast combination methods have better skill score than the base forecasts  We found that   of the series have less than  
nonzero weights  see appendix       many forecast combinations were very sparse   an advantage of our approach
compared to MinT  which produces dense combination
weights  Furthermore  we can see that PERMBUGTOP  is
dominating the other methods for almost all aggregations 
This suggests that computing bottomup mean combined
forecasts is better than reconciling the aggregate and bottom combined mean forecasts  This can be explained by
the fact that PERMBU already produces competitive forecasts with the base forecasts  and so reconciling the bottom
combined forecasts with the aggregate combined forecasts
is unlikely to improve the  nal forecasts 
Finally  the  rst panel shows that all the mean forecast
combination methods have lower skill score than the base
forecasts for the bottom series       for the  rst aggregation  This suggests that improving the forecast accuracy at
the bottom level using forecast combination is particularly
challenging especially with very noisy time series  However  the forecast improvement at the aggregate levels are
magnitudes larger than the decrease in accuracy at the bottom level 

  Conclusion
We have proposed an algorithm to compute coherent probabilistic forecasts for hierarchical time series  The algorithm
provides samples from coherent predictive distributions for
each series in the hierarchy  To do so  we  rst generate independent samples from all series in the hierarchy  Then  
sequence of permutations are applied to the samples in order to restore the dependencies between the children series
of all aggregate series  Finally    sparse forecast combination is applied using the base mean forecasts of all series
in the hierarchy  Our algorithm has the advantage of synthesizing information from multiple levels in the hierarchy 
Using simulated data  and   large scale electricity demand
data set  we showed that restoring the dependencies of the
children series consistently improves the forecast accuracy 
especially in the tails  while the mean forecast combining
weights provide an additional improvement by enabling  
synthesis of information from the different forecasts  Our
algorithm can be used to produce coherent probabilistic
forecasts for hierarchical time series in many applications 

Figure   One week of electricity demand with different number
of aggregated series 

Figure   CRPS skill for different aggregations and average QS
of all aggregate series    positive negative CRPS skill gives the
percentage of decrease increase in CRPS with respect to the base
forecasts  Higher skill score and lower QS are better 

LASSO  After extracting the trend and seasonalities  we
 tted an ARIMA model and computed Gaussian predictive distributions  This is justi ed by the fact that aggregate series are often smoother and easier to forecast  and
by the central limit theorem  For the base forecasts  we
implemented the kernel density estimation approach that
performed the best in the work of Arora   Taylor  
In Figure   the  rst panel gives the skill score for different aggregations computed using the average halfhourly
CRPS over the test set  while the second panel shows the
average QS of all aggregated series  In the  rst panel  we
can see that PERMBU has better skill score than NAIVEBU
especially for large aggregations  The second panel shows
that PERMBU  by modelling the dependence structure  has
contributed to signi cantly decrease the QS in the lower
tail  By analyzing the forecasts  not shown here  we noticed that NAIVEBU is penalized both for not being able to
capture the trend at the top         bad mean forecasts  and
for having too sharp predictive distributions       computed
using   bad dependence structure  The fact that NAIVEBU
seems competitive at moderately large quantiles can be explained by the unnecessarily wide prediction intervals for

Time Log number of aggregated meters CRPS skill  lllllllllllllllNAIVEBUPERMBUPERMBU MINTPERMBU GTOP PERMBU GTOP Aggregate levelsProbability levelQSCoherent Probabilistic Forecasts for Hierarchical Time Series

References
AECOM  Energy demand research project  Final analysis  Technical report  AECOM House  Hertfordshire 
UK   

Arbenz  Philipp  Hummel  Christoph  and Mainik  Georg 
Copula based hierarchical risk aggregation through sample reordering  Insurance  Mathematics   Economics 
   

Arora  Siddharth and Taylor  James    Forecasting electricity smart meter data using conditional kernel density
estimation  Omega    Part     

Berrocal  Veronica    Raftery  Adrian    Gneiting  Tilmann 
and Steed  Richard    Probabilistic weather forecasting
for winter road maintenance  Journal of the American
Statistical Association     

Fan  Yanqin and Patton  Andrew    Copulas in econometrics  Annual Review of Economics     

Friedman  Jerome  Hastie  Trevor      ing  Holger  and
Tibshirani  Robert  Pathwise coordinate optimization 
The Annals of Applied Statistics    December  

Genre    eronique  Kenny  Geoff  Meyler  Aidan  and Timmermann  Allan  Combining expert forecasts  Can anything beat the simple average  International Journal of
Forecasting     

Gneiting  Tilmann  Making and evaluating point forecasts  Journal of the American Statistical Association 
  June  

Gneiting  Tilmann and Katzfuss  Matthias  Probabilistic
forecasting  Annual Review of Statistics and Its Application    January  

Gneiting  Tilmann and Raftery  Adrian    Strictly proper
Journal
scoring rules  prediction  and estimation 
of the American Statistical Association   
   

Gneiting  Tilmann and Ranjan  Roopesh  Comparing density forecasts using thresholdand QuantileWeighted
scoring rules  Journal of Business   Economic Statistics     

Hothorn  Torsten  Kneib  Thomas  and   uhlmann  Peter 
Conditional transformation models  Journal of the Royal
Statistical Society  Series    Statistical methodology   
   

Hyndman  Rob    Ahmed  Roman    Athanasopoulos 
George  and Shang  Han Lin  Optimal combination forecasts for hierarchical time series  Computational Statistics   Data Analysis      September
 

Hyndman  Rob    Lee  Alan    and Wang  Earo  Fast
computation of reconciled forecasts for hierarchical and
grouped time series  Computational Statistics   Data
Analysis    May  

Iman  Ronald   and Conover         distributionfree approach to inducing rank correlation among input variables  Communications in Statistics   Simulation and
Computation     

Kneib  Thomas  Beyond mean regression  Statistical Mod 

elling      August  

Koenker  Roger and Bassett  Gilbert  Regression quantiles 
Econometrica  journal of the Econometric Society   
   

Kremer  Mirko  Siemsen  Enno  and Thomas  Douglas   
The sum and its parts  Judgmental hierarchical forecasting  Management Science     

Laio    and Tamea     Veri cation tools for probabilistic
forecasts of continuous hydrological variables  Hydrology and Earth System Sciences     

Nelsen  Roger    An introduction to copulas  Springer

Science   Business Media   

Patton       Copula methods for forecasting multivariate
time series  Handbook of economic forecasting   April 
   

Patton  Andrew    Modelling asymmetric exchange rate dependence  International Economic Review   
    May  

  uschendorf  Ludger  On the distributional transform 
sklar   theorem  and the empirical copula process  Journal of Statistical Planning and Inference   
    November  

Schefzik  Roman  Thorarinsdottir  Thordis    and Gneiting  Tilmann  Uncertainty quanti cation in complex
simulation models using ensemble copula coupling  Statistical Science    review journal of the Institute of Mathematical Statistics    November  

Sklar     Fonctions de   epartition      dimensions et leurs

marges  Universit   Paris    

Hyndman  Rob   and Athanasopoulos  George  Forecasting  principles and practice  OTexts    September
 

Timmermann     Forecast combinations  In Handbook of
Economic Forecasting  volume   pp    Elsevier 
 

Coherent Probabilistic Forecasts for Hierarchical Time Series

van Erven  Tim and Cugliari  Jairo  GameTheoretically
optimal reconciliation of contemporaneous hierarchical
time series forecasts  In Modeling and Stochastic Learning for Forecasting in High Dimensions  Lecture Notes
in Statistics  pp    Springer International Publishing   

Wickramasuriya  Shanika    Athanasopoulos  George  and
Hyndman  Rob    Forecasting hierarchical and grouped
time series through trace minimization  Technical Report
  Monash University   

